name: ğŸ”— All builds
on:
  workflow_dispatch:
    inputs:
      godot-treeish:
        description: A tag, branch or commit hash in the Godot repository.
        type: string
        default: 4.2
      limboai-treeish:
        description: A tag, branch or commit hash in the LimboAI repository.
        type: string
        default: master
      godot-cpp-treeish:
        description: A tag, branch or commit hash in the godot-cpp repository.
        type: string
        default: 4.2

jobs:
  cache-sha:
    name: Cache treeish SHA
    runs-on: ubuntu-latest
    outputs:
      godot-sha: ${{ steps.cache-sha.outputs.godot-sha }}
      limboai-sha: ${{ steps.cache-sha.outputs.limboai-sha }}
    steps:
      - name: Clone Godot
        uses: actions/checkout@v4
        with:
          repository: godotengine/godot
          ref: ${{ inputs.godot-treeish }}

      - name: Clone LimboAI module
        uses: actions/checkout@v4
        with:
          path: modules/limboai
          ref: ${{ inputs.limboai-treeish }}

      - name: Cache SHA
        id: cache-sha
        run: |
          echo "godot-sha=$(git describe --tags --exact-match HEAD || git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          cd modules/limboai
          echo "limboai-sha=$(git describe --tags --exact-match HEAD || git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  android-build:
    name: ğŸ¤– Android
    needs: cache-sha
    uses: ./.github/workflows/android.yml
    with:
      godot-treeish: ${{ needs.cache-sha.outputs.godot-sha }}
      limboai-treeish: ${{ needs.cache-sha.outputs.limboai-sha }}

  ios-build:
    name: ğŸ iOS
    needs: cache-sha
    uses: ./.github/workflows/ios.yml
    with:
      godot-treeish: ${{ needs.cache-sha.outputs.godot-sha }}
      limboai-treeish: ${{ needs.cache-sha.outputs.limboai-sha }}

  linux-build:
    name: ğŸ§ Linux
    needs: cache-sha
    uses: ./.github/workflows/linux.yml
    with:
      godot-treeish: ${{ needs.cache-sha.outputs.godot-sha }}
      limboai-treeish: ${{ needs.cache-sha.outputs.limboai-sha }}
      test-build: false

  macos-build:
    name: ğŸ macOS
    needs: cache-sha
    uses: ./.github/workflows/macos.yml
    with:
      godot-treeish: ${{ needs.cache-sha.outputs.godot-sha }}
      limboai-treeish: ${{ needs.cache-sha.outputs.limboai-sha }}

  windows-build:
    name: ğŸªŸ Windows
    needs: cache-sha
    uses: ./.github/workflows/windows.yml
    with:
      godot-treeish: ${{ needs.cache-sha.outputs.godot-sha }}
      limboai-treeish: ${{ needs.cache-sha.outputs.limboai-sha }}
      test-build: false

  web-build:
    name: ğŸŒ Web
    needs: cache-sha
    uses: ./.github/workflows/web.yml
    with:
      godot-treeish: ${{ needs.cache-sha.outputs.godot-sha }}
      limboai-treeish: ${{ needs.cache-sha.outputs.limboai-sha }}

  gdextension:
    name: ğŸ”Œ GDExtension
    needs: cache-sha
    uses: ./.github/workflows/gdextension.yml
    with:
      godot-cpp-treeish: ${{ inputs.godot-cpp-treeish }}
      limboai-treeish: ${{ needs.cache-sha.outputs.limboai-sha }}
      test-build: false

  demo:
    name: ğŸ®ï¸ Demo project
    needs: cache-sha
    uses: ./.github/workflows/demo.yml
    with:
      limboai-treeish: ${{ needs.cache-sha.outputs.limboai-sha }}
