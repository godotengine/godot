#!/usr/bin/env python
from misc.utility.scons_hints import *

Import("env")
Import("env_modules")

env_gdscript_elf = env_modules.Clone()

# Enable exceptions (required for sandbox module dependencies)
if env["platform"] == "web":
	env_gdscript_elf.Append(CXXFLAGS=["-fexceptions"])
	env_gdscript_elf.Append(LINKFLAGS=["-fexceptions", "-s", "DISABLE_EXCEPTION_CATCHING=0"])
elif env["platform"] != "windows" or env.get("use_mingw", False):
	env_gdscript_elf.Append(CXXFLAGS=["-fexceptions"])
else:
	env_gdscript_elf.Append(CXXFLAGS=["/EHsc"])

# Add include paths
env_gdscript_elf.Prepend(CPPPATH=["#modules/gdscript_elf/src"])
# Add sandbox/libriscv include paths (needed for guest_datatypes.h which includes libriscv/machine.hpp)
env_gdscript_elf.Prepend(CPPPATH=["#modules/sandbox/thirdparty/libriscv/lib", "#modules/sandbox/src"])

# Source files
sources = [
    "src/gdscript_language_wrapper.cpp",
    "src/gdscript_wrapper.cpp",
    "src/gdscript_function_wrapper.cpp",
    "src/gdscript_bytecode_elf_compiler.cpp",
    "src/gdscript_bytecode_c_codegen.cpp",
    "src/gdscript_c_compiler.cpp",
    "src/gdscript_elf_fallback.cpp",
]

env_gdscript_elf.add_source_files(env.modules_sources, sources)
