#!/usr/bin/env python

Import("env")

from platform_methods import run_in_subprocess
import platform_linuxbsd_builders

thirdparty_dir = "#thirdparty"

common_linuxbsd = [
    "crash_handler_linuxbsd.cpp",
    "os_linuxbsd.cpp",
    "joypad_linux.cpp",
    "freedesktop_screensaver.cpp",
]

if env["x11"]:
    common_linuxbsd += [
        "gl_manager_x11.cpp",
        "detect_prime_x11.cpp",
        "display_server_x11.cpp",
        "key_mapping_x11.cpp",
    ]

    if env["vulkan"]:
        common_linuxbsd.append("vulkan_context_x11.cpp")


if env["wayland"]:
    # TODO: Add warning to headers and code about their autogenerated status.
    WAYLAND_BUILDERS = {
        "WAYLAND_API_HEADER": Builder(
            action=Action(
                "wayland-scanner -c client-header ${SOURCE} ${TARGET}", 'Building Wayland client header: "${TARGET}"'
            ),
            single_source=True,
        ),
        "WAYLAND_API_CODE": Builder(
            action=Action(
                "wayland-scanner -c private-code ${SOURCE} ${TARGET}",
                'Building Wayland protocol marshalling code: "${TARGET}"',
            ),
            single_source=True,
        ),
    }

    env.Append(BUILDERS=WAYLAND_BUILDERS)

    # TODO: Rebuild headers if they change
    env.WAYLAND_API_HEADER(target="wayland.gen.h", source="#thirdparty/wayland/protocol/wayland.xml")
    env.WAYLAND_API_CODE(target="wayland.gen.c", source="#thirdparty/wayland/protocol/wayland.xml")

    env.WAYLAND_API_HEADER(
        target="xdg_shell.gen.h", source="#thirdparty/wayland-protocols/stable/xdg-shell/xdg-shell.xml"
    )

    env.WAYLAND_API_CODE(
        target="xdg_shell.gen.c", source="#thirdparty/wayland-protocols/stable/xdg-shell/xdg-shell.xml"
    )

    env.WAYLAND_API_HEADER(
        target="relative_pointer.gen.h",
        source="#thirdparty/wayland-protocols/unstable/relative-pointer/relative-pointer-unstable-v1.xml",
    )

    env.WAYLAND_API_CODE(
        target="relative_pointer.gen.c",
        source="#thirdparty/wayland-protocols/unstable/relative-pointer/relative-pointer-unstable-v1.xml",
    )

    env.WAYLAND_API_HEADER(
        target="pointer_constraints.gen.h",
        source="#thirdparty/wayland-protocols/unstable/pointer-constraints/pointer-constraints-unstable-v1.xml",
    )

    env.WAYLAND_API_CODE(
        target="pointer_constraints.gen.c",
        source="#thirdparty/wayland-protocols/unstable/pointer-constraints/pointer-constraints-unstable-v1.xml",
    )

    env.WAYLAND_API_HEADER(
        target="wlr_data_control.gen.h",
        source="#thirdparty/wlr-protocols/unstable/wlr-data-control-unstable-v1.xml",
    )

    env.WAYLAND_API_CODE(
        target="wlr_data_control.gen.c",
        source="#thirdparty/wlr-protocols/unstable/wlr-data-control-unstable-v1.xml",
    )

    common_linuxbsd += [
        "wayland.gen.c",
        "xdg_shell.gen.c",
        "relative_pointer.gen.c",
        "pointer_constraints.gen.c",
        "wlr_data_control.gen.c",
        "display_server_wayland.cpp",
        "key_mapping_xkb.cpp",
    ]

    if env["vulkan"]:
        common_linuxbsd.append("vulkan_context_wayland.cpp")

if env["speechd"]:
    common_linuxbsd.append(["speechd-so_wrap.c", "tts_linux.cpp"])

if env["udev"]:
    common_linuxbsd.append("libudev-so_wrap.c")

prog = env.add_program("#bin/godot", ["godot_linuxbsd.cpp"] + common_linuxbsd)

if env["debug_symbols"] and env["separate_debug_symbols"]:
    env.AddPostAction(prog, run_in_subprocess(platform_linuxbsd_builders.make_debug_linuxbsd))
