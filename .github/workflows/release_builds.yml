name: 🚀 Release Build
on:
  release:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release version (e.g. v2.0.1)'
        required: true
        default: 'v2.0.1'
      platforms:
        description: 'Platforms to build (comma-separated: android,ios,web,linux,macos,windows,all)'
        required: true
        default: 'android,ios,linux,macos,windows,web'

concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-release
  cancel-in-progress: true

env:
  ENGINE_VERSION: 4.4.1.stable
  # SCons cache settings to ensure efficient cache utilization
  SCONS_CACHE: "${{github.workspace}}/.scons-cache/"
  SCONS_CACHE_LIMIT: "10000"
  VERSION: 2.0.1
  GODOT_BASE_BRANCH: master
  RELEASE_ARGS: >-
    debug_symbols=false
    disable_3d=true
  EDITOR_ARGS: >-
    debug_symbols=true
  COMMON_ARGS: >-
    optimize=size
    use_volk=no 
    deprecated=no 
    minizip=yes  
    openxr=false 
    vulkan=false 
    graphite=false 
    disable_3d_physics=true 
    disable_navigation=true 
    module_msdfgen_enabled=false 
    module_text_server_adv_enabled=false 
    module_text_server_fb_enabled=true 
    modules_enabled_by_default=true 
    module_gdscript_enabled=true 
    module_freetype_enabled=true 
    module_minimp3_enabled=true 
    module_svg_enabled=true 
    module_jpg_enabled=true 
    module_ogg_enabled=true 
    module_regex_enabled=true 
    module_godot_physics_2d_enabled=true 


jobs:
  setup:
    name: 📋 Prepare Build Environment
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      platforms: ${{ steps.set-platforms.outputs.platforms }}
      godot_base_branch: ${{ steps.set-build-params.outputs.godot_base_branch }}
      engine_version: ${{ steps.set-build-params.outputs.engine_version }}
      common_args: ${{ steps.set-build-params.outputs.common_args }}
      release_args: ${{ steps.set-build-params.outputs.release_args }}
      editor_args: ${{ steps.set-build-params.outputs.editor_args }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set Version Number
        id: set-version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.release_tag }}"
          fi
          VERSION="${VERSION#v}"  # Remove 'v' prefix (if present)
          echo "VERSION=$VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set Build Platforms
        id: set-platforms
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            PLATFORMS="all"
          else
            PLATFORMS="${{ github.event.inputs.platforms }}"
          fi
          
          if [ "$PLATFORMS" == "all" ]; then
            PLATFORMS="android,ios,web,linux,macos,windows"
          fi
          
          echo "PLATFORMS=$PLATFORMS"
          echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT

      - name: Set Build Parameters
        id: set-build-params
        run: |
          echo "godot_base_branch=${{ env.GODOT_BASE_BRANCH }}" >> $GITHUB_OUTPUT
          echo "engine_version=${{ env.ENGINE_VERSION }}" >> $GITHUB_OUTPUT
          echo "common_args=${{ env.COMMON_ARGS }}" >> $GITHUB_OUTPUT
          echo "release_args=${{ env.RELEASE_ARGS }}" >> $GITHUB_OUTPUT
          echo "editor_args=${{ env.EDITOR_ARGS }}" >> $GITHUB_OUTPUT

  android-build:
    name: 🤖 Android Build
    needs: setup
    if: contains(needs.setup.outputs.platforms, 'android') || contains(needs.setup.outputs.platforms, 'all')
    uses: ./.github/workflows/a_depoly_android.yml
    with:
      version: ${{ needs.setup.outputs.version }}
      platforms: ${{ needs.setup.outputs.platforms }}
      godot_base_branch: ${{ needs.setup.outputs.godot_base_branch }}
      engine_version: ${{ needs.setup.outputs.engine_version }}
      common_args: ${{ needs.setup.outputs.common_args }}
      release_args: ${{ needs.setup.outputs.release_args }}
      event_name: ${{ github.event_name }}
      release_tag: ${{ github.event.release.tag_name }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ios-build:
    name: 🍏 iOS Build
    needs: setup
    if: contains(needs.setup.outputs.platforms, 'ios') || contains(needs.setup.outputs.platforms, 'all')
    uses: ./.github/workflows/a_depoly_ios.yml
    with:
      version: ${{ needs.setup.outputs.version }}
      platforms: ${{ needs.setup.outputs.platforms }}
      godot_base_branch: ${{ needs.setup.outputs.godot_base_branch }}
      engine_version: ${{ needs.setup.outputs.engine_version }}
      common_args: ${{ needs.setup.outputs.common_args }}
      release_args: ${{ needs.setup.outputs.release_args }}
      event_name: ${{ github.event_name }}
      release_tag: ${{ github.event.release.tag_name }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  windows-build:
    name: 🪟 Windows Build
    needs: setup
    if: contains(needs.setup.outputs.platforms, 'windows') || contains(needs.setup.outputs.platforms, 'all')
    uses: ./.github/workflows/a_depoly_windows.yml
    with:
      version: ${{ needs.setup.outputs.version }}
      platforms: ${{ needs.setup.outputs.platforms }}
      godot_base_branch: ${{ needs.setup.outputs.godot_base_branch }}
      engine_version: ${{ needs.setup.outputs.engine_version }}
      common_args: ${{ needs.setup.outputs.common_args }}
      release_args: ${{ needs.setup.outputs.release_args }}
      editor_args: ${{ needs.setup.outputs.editor_args }}
      event_name: ${{ github.event_name }}
      release_tag: ${{ github.event.release.tag_name }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  linux-build:
    name: 🐧 Linux Build
    needs: setup
    if: contains(needs.setup.outputs.platforms, 'linux') || contains(needs.setup.outputs.platforms, 'all')
    uses: ./.github/workflows/a_depoly_linux.yml
    with:
      version: ${{ needs.setup.outputs.version }}
      platforms: ${{ needs.setup.outputs.platforms }}
      godot_base_branch: ${{ needs.setup.outputs.godot_base_branch }}
      engine_version: ${{ needs.setup.outputs.engine_version }}
      common_args: ${{ needs.setup.outputs.common_args }}
      release_args: ${{ needs.setup.outputs.release_args }}
      event_name: ${{ github.event_name }}
      release_tag: ${{ github.event.release.tag_name }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  macos-build:
    name: 🍎 macOS Build
    needs: setup
    if: contains(needs.setup.outputs.platforms, 'macos') || contains(needs.setup.outputs.platforms, 'all')
    uses: ./.github/workflows/a_depoly_macos.yml
    with:
      version: ${{ needs.setup.outputs.version }}
      platforms: ${{ needs.setup.outputs.platforms }}
      godot_base_branch: ${{ needs.setup.outputs.godot_base_branch }}
      engine_version: ${{ needs.setup.outputs.engine_version }}
      common_args: ${{ needs.setup.outputs.common_args }}
      release_args: ${{ needs.setup.outputs.release_args }}
      editor_args: ${{ needs.setup.outputs.editor_args }}
      event_name: ${{ github.event_name }}
      release_tag: ${{ github.event.release.tag_name }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  web-build:
    name: 🌐 Web Build
    needs: setup
    if: contains(needs.setup.outputs.platforms, 'web') || contains(needs.setup.outputs.platforms, 'all')
    uses: ./.github/workflows/a_depoly_web.yml
    with:
      version: ${{ needs.setup.outputs.version }}
      platforms: ${{ needs.setup.outputs.platforms }}
      godot_base_branch: ${{ needs.setup.outputs.godot_base_branch }}
      engine_version: ${{ needs.setup.outputs.engine_version }}
      common_args: ${{ needs.setup.outputs.common_args }}
      release_args: ${{ needs.setup.outputs.release_args }}
      editor_args: ${{ needs.setup.outputs.editor_args }}
      event_name: ${{ github.event_name }}
      release_tag: ${{ github.event.release.tag_name }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
